services:
  mariadb:
    image: mariadb:11.4  # Versión LTS (soporte a largo plazo)
    container_name: adonplay-db
    restart: unless-stopped
    # Nota: Ya no necesitas 'privileged: true' para MariaDB en la mayoría de los casos.
    env_file:
      - ./config/.mysql_env
    ports:
      - "3306:3306"
    networks:
      - appnet
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      # Usamos healthcheck.sh que viene incluido en la imagen oficial de MariaDB
      test: [ "CMD-SHELL", "mariadb-admin ping -h localhost -u$$MARIADB_USER -p$$MARIADB_PASSWORD || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 15s

  backend:
    build:
      context: ./rorbackend
      dockerfile: Dockerfile
    container_name: adonplay-backend
    #command: bash -c "rm -f tmp/pids/server.pid && bundle exec rails s -p 9000 -b '0.0.0.0'"
    volumes:
      - ./rorbackend:/app # Mount the current project directory into the /app container
      - bundle_cache:/usr/local/bundle # Volume to cache gems
    ports:
      - "9000:9000" # Map container port 3000 to local machine port 3000
    depends_on:
      mariadb:
        condition: service_healthy
    env_file:
      - ./config/.backend_env
    networks:
      - appnet

  frontend:
    container_name: adonplay-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: runner
      args:
        - NEXT_PUBLIC_NAME_PAGE=${NEXT_PUBLIC_NAME_PAGE}
        - NEXT_PUBLIC_RAILS_ACTION_CABLE_URL=${NEXT_PUBLIC_RAILS_ACTION_CABLE_URL}
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
        - NEXT_PUBLIC_UPLOAD_BASE_URL=${NEXT_PUBLIC_UPLOAD_BASE_URL}
        - NEXT_PUBLIC_FIREBASE_API_KEY=${NEXT_PUBLIC_FIREBASE_API_KEY}
        - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
        - NEXT_PUBLIC_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
        - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
        - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
        - NEXT_PUBLIC_FIREBASE_APP_ID=${NEXT_PUBLIC_FIREBASE_APP_ID}
        - NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}
        - NEXT_PUBLIC_UPLOAD_ENV=${NEXT_PUBLIC_UPLOAD_ENV}
        - NEXT_PUBLIC_FONT_SERVER=${NEXT_PUBLIC_FONT_SERVER}
    ports:
      - "3000:3000"
    networks:
      - appnet
    restart: unless-stopped
    depends_on:
      - backend
      - redis

  frontend-dev:
    profiles:
      - dev
    container_name: adonplay-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
      args:
        - NEXT_PUBLIC_NAME_PAGE=${NEXT_PUBLIC_NAME_PAGE}
        - NEXT_PUBLIC_RAILS_ACTION_CABLE_URL=${NEXT_PUBLIC_RAILS_ACTION_CABLE_URL}
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
        - NEXT_PUBLIC_UPLOAD_BASE_URL=${NEXT_PUBLIC_UPLOAD_BASE_URL}
        - NEXT_PUBLIC_FIREBASE_API_KEY=${NEXT_PUBLIC_FIREBASE_API_KEY}
        - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
        - NEXT_PUBLIC_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
        - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
        - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
        - NEXT_PUBLIC_FIREBASE_APP_ID=${NEXT_PUBLIC_FIREBASE_APP_ID}
        - NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}
        - NEXT_PUBLIC_FONT_SERVER=${NEXT_PUBLIC_FONT_SERVER}
    ports:
      - "3000:3000"
    env_file:
      - ./config/.frontend_env
    networks:
      - appnet
    volumes:
      - ./frontend:/app
    restart: unless-stopped
    depends_on:
      - backend
      - redis

  player:
    container_name: adonplay-player
    build:
      context: ./player
      dockerfile: Dockerfile
      target: runner
      args:
        - NEXT_PUBLIC_PLAYER_API_URL=${NEXT_PUBLIC_PLAYER_API_URL}
        - NEXT_PUBLIC_PLAYER_NAME_PAGE=${NEXT_PUBLIC_PLAYER_NAME_PAGE}
        - NEXT_PUBLIC_PLAYER_UPLOAD_BASE_URL=${NEXT_PUBLIC_PLAYER_UPLOAD_BASE_URL}
        - NEXT_PUBLIC_PLAYER_UPLOAD_IMAGE_URL=${NEXT_PUBLIC_PLAYER_UPLOAD_IMAGE_URL}
        - NEXT_PUBLIC_PLAYER_ACTIVATE_DEVICE_URL=${NEXT_PUBLIC_PLAYER_ACTIVATE_DEVICE_URL}
        - NEXT_PUBLIC_PLAYER_RAILS_ACTION_CABLE_URL=${NEXT_PUBLIC_PLAYER_RAILS_ACTION_CABLE_URL}
        - NEXT_PUBLIC_FIREBASE_API_KEY=${NEXT_PUBLIC_FIREBASE_API_KEY}
        - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
        - NEXT_PUBLIC_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
        - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
        - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
        - NEXT_PUBLIC_FIREBASE_APP_ID=${NEXT_PUBLIC_FIREBASE_APP_ID}
        - NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}
        - NEXT_PUBLIC_UPLOAD_ENV=${NEXT_PUBLIC_UPLOAD_ENV}
    ports:
      - "3001:3001"
    networks:
      - appnet
    restart: unless-stopped
    depends_on:
      - backend
      - redis

  player-dev:
    profiles:
      - dev
    container_name: adonplay-player
    build:
      context: ./player
      dockerfile: Dockerfile
      target: development
      args:
        - NEXT_PUBLIC_PLAYER_API_URL=${NEXT_PUBLIC_PLAYER_API_URL}
        - NEXT_PUBLIC_PLAYER_NAME_PAGE=${NEXT_PUBLIC_PLAYER_NAME_PAGE}
        - NEXT_PUBLIC_PLAYER_UPLOAD_BASE_URL=${NEXT_PUBLIC_PLAYER_UPLOAD_BASE_URL}
        - NEXT_PUBLIC_PLAYER_UPLOAD_IMAGE_URL=${NEXT_PUBLIC_PLAYER_UPLOAD_IMAGE_URL}
        - NEXT_PUBLIC_PLAYER_ACTIVATE_DEVICE_URL=${NEXT_PUBLIC_PLAYER_ACTIVATE_DEVICE_URL}
        - NEXT_PUBLIC_PLAYER_RAILS_ACTION_CABLE_URL=${NEXT_PUBLIC_PLAYER_RAILS_ACTION_CABLE_URL}
        - NEXT_PUBLIC_FIREBASE_API_KEY=${NEXT_PUBLIC_FIREBASE_API_KEY}
        - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
        - NEXT_PUBLIC_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
        - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
        - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
        - NEXT_PUBLIC_FIREBASE_APP_ID=${NEXT_PUBLIC_FIREBASE_APP_ID}
        - NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}
        - NEXT_PUBLIC_UPLOAD_ENV=${NEXT_PUBLIC_UPLOAD_ENV}
    ports:
      - "3001:3001"
    env_file:
      - ./config/.player_env
    networks:
      - appnet
    volumes:
      - ./player:/app
    restart: unless-stopped
    depends_on:
      - backend
      - redis

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: adonplay-phpmyadmin
    restart: unless-stopped
    ports:
      - "8080:80"
    networks:
      - appnet
    env_file:
      - ./config/.phpmyadmin_env
    depends_on:
      - mariadb

  nginx:
    image: nginx:alpine
    container_name: adonplay-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443" # Abrimos el puerto SSL
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./certbot/conf:/etc/letsencrypt # Donde se guardarán los certificados
      - ./certbot/www:/var/www/certbot   # Para el desafío de validación
    depends_on:
      - backend
      - frontend
      - player
      - redis
      - phpmyadmin
    networks:
      - appnet

  certbot:
    image: certbot/certbot
    container_name: adonplay-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    # Este comando intenta renovar los certificados cada 12 horas
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - appnet

  #  docker compose run --rm --entrypoint "certbot" certbot certonly --webroot --webroot-path=/var/www/certbot \
  #  --email tu-email@ejemplo.com \
  #  --agree-tos \
  #  --no-eff-email \
  #  -d api-adonplay.com \
  #  -d frontend-adonplay.com \
  #  -d player-adonplay.com \
  #  -d ws-adonplay.com

  redis:
    image: "redis:alpine"
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - appnet

networks:
  appnet:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1400 # Valor seguro para la mayoría de networks

volumes:
  vendor:
  mariadb_data:
  node_modules:
  bundle_cache: