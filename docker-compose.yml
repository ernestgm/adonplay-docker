services:
  mysql:
    image: mysql:8
    container_name: adonplay-mysql
    restart: unless-stopped
    # >>> SOLUCIÓN: Agregando la directiva privileged <<<
    privileged: true
    # >>> FIN SOLUCIÓN <<<
    env_file:
      - ./config/.mysql_env
    ports:
      - "3306:3306"
    networks:
      - appnet
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u$$MYSQL_USER", "-p$$MYSQL_PASSWORD" ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 20s # Dale tiempo a MySQL para inicializarse

  backend:
    build:
      context: ./rorbackend
      dockerfile: Dockerfile
    container_name: adonplay-backend
    #command: bash -c "rm -f tmp/pids/server.pid && bundle exec rails s -p 9000 -b '0.0.0.0'"
    volumes:
      - ./rorbackend:/app # Mount the current project directory into the /app container
      - bundle_cache:/usr/local/bundle # Volume to cache gems
    ports:
      - "9000:9000" # Map container port 3000 to local machine port 3000
    depends_on:
      mysql:
        condition: service_healthy
    env_file:
      - ./config/.backend_env
    networks:
      - appnet

  frontend:
    container_name: adonplay-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: runner
      args:
        - NEXT_PUBLIC_NAME_PAGE=${NEXT_PUBLIC_NAME_PAGE}
        - NEXT_PUBLIC_RAILS_ACTION_CABLE_URL=${NEXT_PUBLIC_RAILS_ACTION_CABLE_URL}
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
        - NEXT_PUBLIC_UPLOAD_BASE_URL=${NEXT_PUBLIC_UPLOAD_BASE_URL}
    ports:
      - "3000:3000"
    networks:
      - appnet
    restart: unless-stopped
    depends_on:
      - backend
      - redis

  frontend-dev:
    profiles:
      - dev
    container_name: adonplay-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
    ports:
      - "3000:3000"
    env_file:
      - ./config/.frontend_env
    networks:
      - appnet
    volumes:
      - ./frontend:/app
    restart: unless-stopped
    depends_on:
      - backend
      - redis

  player:
    container_name: adonplay-player
    build:
      context: ./player
      dockerfile: Dockerfile
      target: runner
      args:
        - NEXT_PUBLIC_PLAYER_API_URL=${NEXT_PUBLIC_PLAYER_API_URL}
        - NEXT_PUBLIC_PLAYER_NAME_PAGE=${NEXT_PUBLIC_PLAYER_NAME_PAGE}
        - NEXT_PUBLIC_PLAYER_UPLOAD_BASE_URL=${NEXT_PUBLIC_PLAYER_UPLOAD_BASE_URL}
        - NEXT_PUBLIC_PLAYER_UPLOAD_IMAGE_URL=${NEXT_PUBLIC_PLAYER_UPLOAD_IMAGE_URL}
        - NEXT_PUBLIC_PLAYER_ACTIVATE_DEVICE_URL=${NEXT_PUBLIC_PLAYER_ACTIVATE_DEVICE_URL}
        - NEXT_PUBLIC_PLAYER_RAILS_ACTION_CABLE_URL=${NEXT_PUBLIC_PLAYER_RAILS_ACTION_CABLE_URL}
    ports:
      - "3001:3001"
    networks:
      - appnet
    restart: unless-stopped
    depends_on:
      - backend
      - redis

  player-dev:
    profiles:
      - dev
    container_name: adonplay-player
    build:
      context: ./player
      dockerfile: Dockerfile
      target: development
    ports:
      - "3001:3001"
    env_file:
      - ./config/.player_env
    networks:
      - appnet
    volumes:
      - ./player:/app
    restart: unless-stopped
    depends_on:
      - backend
      - redis

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: adonplay-phpmyadmin
    restart: unless-stopped
    ports:
      - "8080:80"
    networks:
      - appnet
    env_file:
      - ./config/.phpmyadmin_env
    depends_on:
      - mysql

  nginx:
    image: nginx:alpine
    container_name: adonplay-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend
      - frontend
      - player
      - redis
    networks:
      - appnet

  redis:
    image: "redis:alpine"
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - appnet

networks:
  appnet:
    driver: bridge

volumes:
  vendor:
  mysql_data:
  node_modules:
  bundle_cache: